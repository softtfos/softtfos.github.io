var progressBar={update:function(r,o){var a=+$(".progress .progress-bar").attr("aria-valuenow");console.log(a);var e=r+a;$(".progress .progress-bar").css("width",e+"%").attr("aria-valuenow",e),$(".progress .val").text(e+"%"),$(".description").text(o)},clear:function(){$(".progress .progress-bar").css("width","0%").attr("aria-valuenow",0),$(".progress .val").text("0%"),$(".description").text("Loading")},calculatePercentage:function(r,o){if(r<o||o<=0)throw new Error("Error! Percent should be >= portion and portion > 0");for(var a=Math.round(r/o),e=a*o-r,t=[],s=0;s<o-1;s++)t.push(a);return e>0||e<0?t.push(a-e):t.push(a),t}};
var table;$(document).ready(function(){$("#menu-item-3").addClass("menu-active"),table=$("#myTable").DataTable({columnDefs:[{targets:"_all",defaultContent:"-"}],columns:[{title:"Number",data:"Number"},{title:"Status",data:"Status",width:"35%"},{title:"DatePayedKeeping",data:"DatePayedKeeping"},{title:"InitialDocNumber",data:"InitialDocumentNumber"},{title:"OrderNumber",data:"OrderNumber"},{title:"Cost",data:"DocumentCost"}]}),$("#datepickerFrom").datepicker({format:"dd.mm.yyyy",autoclose:!0,defaultDateDelta:null}),$("#datepickerTo").datepicker({format:"dd.mm.yyyy",autoclose:!0,defaultDateDelta:null}),$("#datepickerPair").datepair(),localStorage.length&&($("#datepickerFrom").val(localStorage.getItem("dateFrom")),$("#datepickerTo").val(localStorage.getItem("dateTo")))});function sendAjax(e,a,t){for(var r=[],o=JSON.parse(localStorage.getItem("apiKeyArr")),l=progressBar.calculatePercentage(50,o.length),n=0,c=0;c<o.length;c++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({apiKey:o[c].apiKey,modelName:"AdditionalService",calledMethod:"getReturnOrdersList",methodProperties:{BeginDate:e,EndDate:a}}),success:function(e,a){if(progressBar.update(l[n],"Profiles data loading ("+ ++n+"/"+o.length+")"),r.push(e.data),flags.splice(0,1),!flags.length){for(var t=[],c=0;c<r.length;c++)t=t.concat(r[c]);collectData(t);sendTtnAjax(prepareTtn(t))}}})}var flags=[],savedInfo=[];function collectData(e){for(var a=0;a<e.length;a++)savedInfo[e[a].ExpressWaybillNumber]={InitialDocumentNumber:e[a].DocumentNumber,OrderNumber:e[a].OrderNumber}}function sendTtnAjax(e){for(var a=[],t=progressBar.calculatePercentage(50,e.length),r=0,o=0;o<e.length;o++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({modelName:"TrackingDocument",calledMethod:"getStatusDocuments",methodProperties:{Documents:e[o]}}),success:function(o,l){if(progressBar.update(t[r],"TTN data loading ("+ ++r+"/"+e.length+")"),a.push(o.data),flags.splice(0,1),!flags.length){for(var n=concatTtnArrays(a),c=0;c<n.length;c++)n[c].InitialDocumentNumber=savedInfo[n[c].Number].InitialDocumentNumber,n[c].OrderNumber=savedInfo[n[c].Number].OrderNumber;console.log("Filtered array "+n.length),drawTable(n)}}})}function concatTtnArrays(e){for(var a=[],t=0;t<e.length;t++)a=a.concat(e[t]);var r={};return a.filter(function(e){return e.Number in r?0:r[e.Number]=1})}function drawTable(e){table.clear(),table.rows.add(e).draw()}function prepareTtn(e){var a,t=localStorage.getItem("phoneNumber"),r=0,o=100,l=[];for(l.push([]),a=0;a<e.length;a++)a>=o&&(r++,o+=100,l.push([])),l[r].push({DocumentNumber:e[a].ExpressWaybillNumber,Phone:t});return l}$("#checkBtn").click(function(){progressBar.clear();var e=$("#datepickerFrom").val(),a=$("#datepickerTo").val();updateRanges(e,a),sendAjax(e,a)});function updateRanges(e,a){localStorage.length?(localStorage.getItem("dateFrom")!==e&&localStorage.setItem("dateFrom",e),localStorage.getItem("dateTo")!==a&&localStorage.setItem("dateTo",a)):(localStorage.setItem("dateFrom",e),localStorage.setItem("dateTo",a))}$("#clearBtn").click(function(){$("#datepickerFrom").val(""),$("#datepickerTo").val(""),localStorage.removeItem("dateFrom"),localStorage.removeItem("dateTo")});