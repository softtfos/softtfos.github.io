window.BuildingData={tables:{options:{multiTtnPage:{columnDefs:[{targets:"_all",defaultContent:"-"}],columns:[{title:"Number",data:"Number"},{title:"Status",data:"Status",width:"45%"},{title:"DatePayedKeeping",data:"DatePayedKeeping",render:function(t){return(t=t.split(" "))[0]}},{title:"Weight (kg)",data:"DocumentWeight"},{title:"Cost",data:"DocumentCost"}],rowCallback:function(t,e){var a="",n=parseInt(e.StatusCode);7===n||8===n?a="wait":n>=9&&n<=11?a="done":6===n&&(a="soon"),$(t).addClass(a)}},paymentPage:{columnDefs:[{targets:-1,data:"LastCreatedOnTheBasisDocumentType",render:function(t){return"CargoReturn"===t?"Y":""}},{targets:"_all",defaultContent:"-"}],columns:[{title:"Number",data:"Number"},{title:"Status",data:"Status",width:"35%"},{title:"Weight (kg)",data:"DocumentWeight",weight:"5%"},{title:"DatePayedKeeping",data:"DatePayedKeeping",render:function(t){return(t=t.split(" "))[0]}},{title:"OrderId",data:"ClientBarcode"},{title:"Cost",data:"AnnouncedPrice"},{title:"Return",data:"LastCreatedOnTheBasisDocumentType",width:"5%"}]},returnPage:{columnDefs:[{targets:"_all",defaultContent:"-"}],columns:[{title:"Number",data:"Number"},{title:"Status",data:"Status",width:"35%"},{title:"DatePayedKeeping",data:"DatePayedKeeping",render:function(t){return(t=t.split(" "))[0]}},{title:"InitialDocNumber",data:"InitialDocumentNumber"},{title:"Price",data:"AnnouncedPrice"},{title:"Penalty",data:"Cost"}]}}}};
!function(){var t="dateFrom",e="apiKeyArr",o={from:{set:function(e){localStorage.setItem(t,e)},get:function(){return localStorage.getItem(t)},remove:function(){localStorage.removeItem(t)}},to:{set:function(t){localStorage.setItem("dateTo",t)},get:function(){return localStorage.getItem("dateTo")},remove:function(){localStorage.removeItem("dateTo")}}},n={get:function(){return JSON.parse(localStorage.getItem(e))},set:function(t){localStorage.setItem(e,JSON.stringify(t))},remove:function(){localStorage.removeItem(e)}},r={get:function(){return localStorage.getItem("ttnList")},set:function(t){localStorage.setItem("ttnList",t)}};window.ClientStorage={updateTimeRange:function(t,e){o.from.get()!==t&&o.from.set(t),o.to.get()!==e&&o.to.set(e)},updateTtnList:function(t){r.get()!==t&&r.set(t)},getTtnList:function(){return r.get()},getTimeRange:function(){return{from:o.from.get(),to:o.to.get()}},removeTimeRange:function(){o.from.remove(),o.to.remove()},getAccounts:function(){return n.get()},initAccount:function(){n.set([])},setAccount:function(t,e){var o=n.get();o.push({apiKey:t,phoneNumber:e}),n.set(o)},removeAccount:function(t){var e=n.get();e.splice(t,1),n.set(e)},removeAccounts:function(){n.remove()}}}();
var progressBar={update:function(r,t){var a=r+ +$(".progress .progress-bar").attr("aria-valuenow");$(".progress .progress-bar").css("width",a+"%").attr("aria-valuenow",a),$(".progress .val").text(a+"%"),$(".description").text(t)},clear:function(){$(".progress .progress-bar").css("width","0%").attr("aria-valuenow",0),$(".progress .val").text("0%"),$(".description").text("Loading")},calculatePercentage:function(r,t){if(r<t||t<=0)throw new Error("Error! Percent should be >= portion and portion > 0");for(var a=Math.round(r/t),e=a*t-r,o=[],s=0;s<t-1;s++)o.push(a);return e>0||e<0?o.push(a-e):o.push(a),o}};
!function(t){DataStorage={ttnTracking:function(e,a){t.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({modelName:"TrackingDocument",calledMethod:"getStatusDocuments",methodProperties:{Documents:e}}),success:a})},getTtnInfo:function(e,a,o,n){t.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({apiKey:apiKeyArr[i].apiKey,modelName:"InternetDocument",calledMethod:"getDocumentList",methodProperties:{DateTimeFrom:a,DateTimeTo:o,GetFullList:"1",UnassembledCargo:"1"}}),success:n})}}}($);
var Table,flags=[],savedInfo=[],commonTrackingDocuments=[];$(document).ready(function(){$("#menu-item-3").addClass("menu-active"),Table=$("#myTable").DataTable(BuildingData.tables.options.returnPage),applyTimeRangeOptions(),$("#tableWrapper .row").each(function(){$(this).find("#myTable").length||$(this).addClass("noPrint")})});function getReturnOrdersListFromAccounts(e,a){for(var t=[],r=ClientStorage.getAccounts(),n=progressBar.calculatePercentage(25,r.length),o=0,s=0;s<r.length;s++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({apiKey:r[s].apiKey,modelName:"AdditionalService",calledMethod:"getReturnOrdersList",methodProperties:{BeginDate:e,EndDate:a}}),success:function(s){if(progressBar.update(n[o],"Profiles data loading ("+ ++o+"/"+r.length+")"),t.push(s.data),flags.splice(0,1),!flags.length){var c=combineArrayOfArrays(t);collectDocumentsData(c,{mainNumber:"ExpressWaybillNumber",initialNumber:"DocumentNumber",orderNumber:"OrderNumber"});for(var i=prepareDocumentsForTracking(c,{fields:{documentNumber:"ExpressWaybillNumber",phone:"RecipientPhone"}}),u=0;u<i.length;u++)commonTrackingDocuments.push(i[u]);getDocumentListFromAccounts(e,a)}}})}function getDocumentListFromAccounts(e,a){for(var t=[],r=ClientStorage.getAccounts(),n=progressBar.calculatePercentage(25,r.length),o=0,s=0;s<r.length;s++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({apiKey:r[s].apiKey,modelName:"InternetDocument",calledMethod:"getDocumentList",methodProperties:{DateTimeFrom:e,DateTimeTo:a,GetFullList:"1",UnassembledCargo:"1"}}),success:function(e,a){if(progressBar.update(n[o],"Profiles data loading ("+ ++o+"/"+r.length+")"),t.push(e.data),flags.splice(0,1),!flags.length){for(var s=combineArrayOfArrays(t),c=[],i=0;i<s.length;i++){var u=+s[i].StateId;102!==u&&103!==u&&108!==u||c.push(s[i])}getReturnDocuments(prepareDocumentsForTracking(c,{fields:{documentNumber:"IntDocNumber",phone:"RecipientContactPhone"}}))}}})}function getReturnDocuments(e){for(var a=[],t=progressBar.calculatePercentage(25,e.length),r=0,n=0;n<e.length;n++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({modelName:"TrackingDocument",calledMethod:"getStatusDocuments",methodProperties:{Documents:e[n]}}),success:function(n){if(progressBar.update(t[r],"TTN data loading ("+ ++r+"/"+e.length+")"),a.push(n.data),flags.splice(0,1),!flags.length){var o=combineArrayOfArrays(a);collectDocumentsData(o=filterDuplicateNumbers(o),{mainNumber:"LastCreatedOnTheBasisNumber",initialNumber:"Number"});for(var s=prepareDocumentsForTracking(o,{fields:{documentNumber:"LastCreatedOnTheBasisNumber",phone:"PhoneSender"}}),c=0;c<s.length;c++)commonTrackingDocuments.push(s[c]);getTrackingDocuments(commonTrackingDocuments)}}})}function getTrackingDocuments(e){for(var a=[],t=progressBar.calculatePercentage(25,e.length),r=0,n=0;n<e.length;n++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({modelName:"TrackingDocument",calledMethod:"getStatusDocuments",methodProperties:{Documents:e[n]}}),success:function(n){if(progressBar.update(t[r],"TTN data loading ("+ ++r+"/"+e.length+")"),a.push(n.data),flags.splice(0,1),!flags.length){var o=combineArrayOfArrays(a);o=filterDuplicateNumbers(o);for(var s=[],c=0;c<o.length;c++)7!=+o[c].StatusCode&&8!=+o[c].StatusCode||s.push(o[c]);var i=0;for(c=0;c<s.length;c++)s[c].InitialDocumentNumber=savedInfo[s[c].Number].InitialDocumentNumber,s[c].DatePayedKeeping&&(s[c].Cost=calculateParcelPenalty(s[c]),i+=s[c].Cost);console.log("Filtered array "+s.length),$("#commonCost").text(i+" grn"),drawTable(s),commonTrackingDocuments=[]}}})}$("#checkBtn").click(function(){progressBar.clear();var e=$("#datepickerFrom").val(),a=$("#datepickerTo").val();ClientStorage.updateTimeRange(e,a),getReturnOrdersListFromAccounts(e,a)}),$("#clearBtn").click(clearTimeRanges);function calculateParcelPenalty(e){return moment(e.DatePayedKeeping)>moment()?e.DocumentCost:e.DocumentCost+15*(compareDates(e.DatePayedKeeping)+1)}function filterDuplicateNumbers(e){var a={};return e.filter(function(e){return e.Number in a?0:a[e.Number]=1})}function drawTable(e){Table.clear(),Table.rows.add(e).draw()}function prepareDocumentsForTracking(e,a){var t,r=0,n=100,o=[];for(o.push([]),t=0;t<e.length;t++)t>=n&&(r++,n+=100,o.push([])),o[r].push({DocumentNumber:e[t][a.fields.documentNumber],Phone:e[t][a.fields.phone]});return o}function collectDocumentsData(e,a){for(var t=0;t<e.length;t++)savedInfo[e[t][a.mainNumber]]={InitialDocumentNumber:e[t][a.initialNumber]}}function combineArrayOfArrays(e){for(var a=[],t=0;t<e.length;t++)a=a.concat(e[t]);return a}function clearTimeRanges(){$("#datepickerFrom").val(""),$("#datepickerTo").val(""),ClientStorage.removeTimeRange()}function compareDates(e){var a=moment(e),t=moment(),r=0;0===a.day()&&a.day(1),0===t.day()&&t.day(-1);var n=a.week(),o=t.week();return n!==o&&(o<n&&(o+=n),r=-1*(o-n)),t.diff(a,"days")+r}function applyTimeRangeOptions(){var e=$("#datepickerFrom"),a=$("#datepickerTo"),t={format:"dd.mm.yyyy",autoclose:!0,defaultDateDelta:null};e.datepicker(t),a.datepicker(t),$("#datepickerPair").datepair();var r=ClientStorage.getTimeRange();e.val(r.from),a.val(r.to)}