var progressBar={update:function(r,t){var a=r+ +$(".progress .progress-bar").attr("aria-valuenow");$(".progress .progress-bar").css("width",a+"%").attr("aria-valuenow",a),$(".progress .val").text(a+"%"),$(".description").text(t)},clear:function(){$(".progress .progress-bar").css("width","0%").attr("aria-valuenow",0),$(".progress .val").text("0%"),$(".description").text("Loading")},calculatePercentage:function(r,t){if(r<t||t<=0)throw new Error("Error! Percent should be >= portion and portion > 0");for(var a=Math.round(r/t),e=a*t-r,o=[],s=0;s<t-1;s++)o.push(a);return e>0||e<0?o.push(a-e):o.push(a),o}};
var table;$(document).ready(function(){$("#menu-item-3").addClass("menu-active"),table=$("#myTable").DataTable({columnDefs:[{targets:"_all",defaultContent:"-"}],columns:[{title:"Number",data:"Number"},{title:"Status",data:"Status",width:"35%"},{title:"DatePayedKeeping",data:"DatePayedKeeping"},{title:"InitialDocNumber",data:"InitialDocumentNumber"},{title:"Price",data:"CommonPrice"},{title:"Cost",data:"Cost"}]}),$("#datepickerFrom").datepicker({format:"dd.mm.yyyy",autoclose:!0,defaultDateDelta:null}),$("#datepickerTo").datepicker({format:"dd.mm.yyyy",autoclose:!0,defaultDateDelta:null}),$("#datepickerPair").datepair(),localStorage.length&&($("#datepickerFrom").val(localStorage.getItem("dateFrom")),$("#datepickerTo").val(localStorage.getItem("dateTo")))});function sendAjax(e,t,a){for(var r=[],o=JSON.parse(localStorage.getItem("apiKeyArr")),n=progressBar.calculatePercentage(50,o.length),l=0,c=0;c<o.length;c++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({apiKey:o[c].apiKey,modelName:"AdditionalService",calledMethod:"getReturnOrdersList",methodProperties:{BeginDate:e,EndDate:t}}),success:function(e,t){if(progressBar.update(n[l],"Profiles data loading ("+ ++l+"/"+o.length+")"),r.push(e.data),flags.splice(0,1),!flags.length){for(var a=[],c=0;c<r.length;c++)a=a.concat(r[c]);collectData(a);sendTtnAjax(prepareTtn(a))}}})}var flags=[],savedInfo=[];function collectData(e){for(var t=0;t<e.length;t++)savedInfo[e[t].ExpressWaybillNumber]={InitialDocumentNumber:e[t].DocumentNumber,OrderNumber:e[t].OrderNumber}}function sendTtnAjax(e){for(var t=[],a=progressBar.calculatePercentage(50,e.length),r=0,o=0;o<e.length;o++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({modelName:"TrackingDocument",calledMethod:"getStatusDocuments",methodProperties:{Documents:e[o]}}),success:function(o,n){if(progressBar.update(a[r],"TTN data loading ("+ ++r+"/"+e.length+")"),t.push(o.data),flags.splice(0,1),!flags.length){for(var l=concatTtnArrays(t),c=[],s=0;s<l.length;s++)7!=+l[s].StatusCode&&8!=+l[s].StatusCode||c.push(l[s]);var d=0;for(s=0;s<c.length;s++)c[s].InitialDocumentNumber=savedInfo[c[s].Number].InitialDocumentNumber,c[s].OrderNumber=savedInfo[c[s].Number].OrderNumber,c[s].CommonPrice=c[s].AnnouncedPrice+2*c[s].DocumentCost,c[s].DatePayedKeeping&&(moment(c[s].DatePayedKeeping)>moment()?c[s].Cost=c[s].DocumentCost:c[s].Cost=c[s].DocumentCost+15*(compareDates(c[s].DatePayedKeeping)+1),d+=c[s].Cost);console.log("Filtered array "+c.length),$("#commonCost").text(d+" grn"),drawTable(c)}}})}function concatTtnArrays(e){for(var t=[],a=0;a<e.length;a++)t=t.concat(e[a]);var r={};return t.filter(function(e){return e.Number in r?0:r[e.Number]=1})}function drawTable(e){table.clear(),table.rows.add(e).draw()}function prepareTtn(e){var t,a=0,r=100,o=[];for(o.push([]),t=0;t<e.length;t++)t>=r&&(a++,r+=100,o.push([])),o[a].push({DocumentNumber:e[t].ExpressWaybillNumber,Phone:e[t].RecipientPhone});return o}$("#checkBtn").click(function(){progressBar.clear();var e=$("#datepickerFrom").val(),t=$("#datepickerTo").val();updateRanges(e,t),sendAjax(e,t)});function updateRanges(e,t){localStorage.length?(localStorage.getItem("dateFrom")!==e&&localStorage.setItem("dateFrom",e),localStorage.getItem("dateTo")!==t&&localStorage.setItem("dateTo",t)):(localStorage.setItem("dateFrom",e),localStorage.setItem("dateTo",t))}function compareDates(e){var t=moment(e),a=moment(),r=0;0===t.day()&&t.day(1),0===a.day()&&a.day(-1);var o=t.week(),n=a.week();return o!==n&&(n<o&&(n+=o),r=-1*(n-o)),a.diff(t,"days")+r}$("#clearBtn").click(function(){$("#datepickerFrom").val(""),$("#datepickerTo").val(""),localStorage.removeItem("dateFrom"),localStorage.removeItem("dateTo")});