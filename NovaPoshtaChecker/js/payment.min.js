var progressBar={update:function(r,t){var a=r+ +$(".progress .progress-bar").attr("aria-valuenow");$(".progress .progress-bar").css("width",a+"%").attr("aria-valuenow",a),$(".progress .val").text(a+"%"),$(".description").text(t)},clear:function(){$(".progress .progress-bar").css("width","0%").attr("aria-valuenow",0),$(".progress .val").text("0%"),$(".description").text("Loading")},calculatePercentage:function(r,t){if(r<t||t<=0)throw new Error("Error! Percent should be >= portion and portion > 0");for(var a=Math.round(r/t),e=a*t-r,o=[],s=0;s<t-1;s++)o.push(a);return e>0||e<0?o.push(a-e):o.push(a),o}};
var table;$.fn.dataTable.ext.search.push(function(e,t){var a=!1,r=!0;return $("#inlineCheckbox1").is(":checked")&&(a=a||t[1].includes("Відмова від отримання"),r=!1),$("#inlineCheckbox2").is(":checked")&&(a=a||t[1].includes("Прибув у відділення"),r=!1),$("#inlineCheckbox3").is(":checked")&&(a=a||!t[6],r=!1),a||r}),$(document).ready(function(){$("#menu-item-2").addClass("menu-active"),table=$("#myTable").DataTable({columnDefs:[{targets:-1,data:"LastCreatedOnTheBasisDocumentType",render:function(e){return"CargoReturn"===e?"Y":""}},{targets:"_all",defaultContent:"-"}],columns:[{title:"Number",data:"Number"},{title:"Status",data:"Status",width:"35%"},{title:"Weight (kg)",data:"DocumentWeight",weight:"5%"},{title:"DatePayedKeeping",data:"DatePayedKeeping"},{title:"OrderId",data:"ClientBarcode"},{title:"Cost",data:"AnnouncedPrice"},{title:"Return",data:"LastCreatedOnTheBasisDocumentType",width:"5%"}]});var e={format:"dd.mm.yyyy",autoclose:!0,defaultDateDelta:null};$("#datepickerFrom").datepicker(e),$("#datepickerTo").datepicker(e),$("#datepickerPair").datepair(),localStorage.length&&($("#datepickerFrom").val(localStorage.getItem("dateFrom")),$("#datepickerTo").val(localStorage.getItem("dateTo"))),$("#inlineCheckbox1, #inlineCheckbox2, #inlineCheckbox3").on("change",function(){table.draw()})});function getApisData(e,t,a){for(var r=[],o=JSON.parse(localStorage.getItem("apiKeyArr")),n=progressBar.calculatePercentage(50,o.length),l=0,c=0;c<o.length;c++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({apiKey:o[c].apiKey,modelName:"InternetDocument",calledMethod:"getDocumentList",methodProperties:{DateTimeFrom:e,DateTimeTo:t,GetFullList:"1",UnassembledCargo:"1"}}),success:function(e,t){if(progressBar.update(n[l],"Profiles data loading ("+ ++l+"/"+o.length+")"),r.push(e.data),flags.splice(0,1),!flags.length){for(var a=[],c=0;c<r.length;c++)a=a.concat(r[c]);sendTtnAjax(prepareTtn(a))}}})}var flags=[];function sendTtnAjax(e){for(var t=[],a=progressBar.calculatePercentage(50,e.length),r=0,o=0;o<e.length;o++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({modelName:"TrackingDocument",calledMethod:"getStatusDocuments",methodProperties:{Documents:e[o]}}),success:function(o,n){if(progressBar.update(a[r],"TTN data loading ("+ ++r+"/"+e.length+")"),t.push(o.data),flags.splice(0,1),!flags.length){var l=concatTtnArrays(t);console.log("Filtered array "+l.length),drawTable(l)}}})}function concatTtnArrays(e){for(var t=[],a=0;a<e.length;a++)t=t.concat(e[a]);var r={};return t.filter(function(e){return e.Number in r?0:r[e.Number]=1})}function prepareTtn(e){console.log(e);var t,a=0,r=100,o=[];for(o.push([]),t=0;t<e.length;t++)t>=r&&(a++,r+=100,o.push([])),o[a].push({DocumentNumber:e[t].IntDocNumber,Phone:e[t].RecipientContactPhone});return o}function drawTable(e){table.clear(),table.rows.add(e).draw()}$("#checkBtn").click(function(){progressBar.clear();var e=$("#datepickerFrom").val(),t=$("#datepickerTo").val();updateRanges(e,t),getApisData(e,t)});function updateRanges(e,t){localStorage.length?(localStorage.getItem("dateFrom")!==e&&localStorage.setItem("dateFrom",e),localStorage.getItem("dateTo")!==t&&localStorage.setItem("dateTo",t)):(localStorage.setItem("dateFrom",e),localStorage.setItem("dateTo",t))}$("#clearBtn").click(function(){$("#datepickerFrom").val(""),$("#datepickerTo").val(""),localStorage.removeItem("dateFrom"),localStorage.removeItem("dateTo")});