window.BuildingData={tables:{options:{multiTtnPage:{columnDefs:[{targets:"_all",defaultContent:"-"}],columns:[{title:"Number",data:"Number"},{title:"Status",data:"Status",width:"45%"},{title:"DatePayedKeeping",data:"DatePayedKeeping",render:function(t){return(t=t.split(" "))[0]}},{title:"Weight (kg)",data:"DocumentWeight"},{title:"Cost",data:"DocumentCost"}],rowCallback:function(t,e){var a="",n=parseInt(e.StatusCode);7===n||8===n?a="wait":n>=9&&n<=11?a="done":6===n&&(a="soon"),$(t).addClass(a)}},paymentPage:{columnDefs:[{targets:-1,data:"LastCreatedOnTheBasisDocumentType",render:function(t){return"CargoReturn"===t?"Y":""}},{targets:"_all",defaultContent:"-"}],columns:[{title:"Number",data:"Number"},{title:"Status",data:"Status",width:"35%"},{title:"Weight (kg)",data:"DocumentWeight",weight:"5%"},{title:"DatePayedKeeping",data:"DatePayedKeeping",render:function(t){return(t=t.split(" "))[0]}},{title:"OrderId",data:"ClientBarcode"},{title:"Cost",data:"AnnouncedPrice"},{title:"Return",data:"LastCreatedOnTheBasisDocumentType",width:"5%"}]},returnPage:{columnDefs:[{targets:"_all",defaultContent:"-"}],columns:[{title:"Number",data:"Number"},{title:"Status",data:"Status",width:"35%"},{title:"DatePayedKeeping",data:"DatePayedKeeping",render:function(t){return(t=t.split(" "))[0]}},{title:"InitialDocNumber",data:"InitialDocumentNumber"},{title:"Price",data:"AnnouncedPrice"},{title:"Penalty",data:"Cost"}]}}}};
!function(){var t="dateFrom",e="apiKeyArr",o={from:{set:function(e){localStorage.setItem(t,e)},get:function(){return localStorage.getItem(t)},remove:function(){localStorage.removeItem(t)}},to:{set:function(t){localStorage.setItem("dateTo",t)},get:function(){return localStorage.getItem("dateTo")},remove:function(){localStorage.removeItem("dateTo")}}},n={get:function(){return JSON.parse(localStorage.getItem(e))},set:function(t){localStorage.setItem(e,JSON.stringify(t))},remove:function(){localStorage.removeItem(e)}},r={get:function(){return localStorage.getItem("ttnList")},set:function(t){localStorage.setItem("ttnList",t)}};window.ClientStorage={updateTimeRange:function(t,e){o.from.get()!==t&&o.from.set(t),o.to.get()!==e&&o.to.set(e)},updateTtnList:function(t){r.get()!==t&&r.set(t)},getTtnList:function(){return r.get()},getTimeRange:function(){return{from:o.from.get(),to:o.to.get()}},removeTimeRange:function(){o.from.remove(),o.to.remove()},getAccounts:function(){return n.get()},initAccount:function(){n.set([])},setAccount:function(t,e){var o=n.get();o.push({apiKey:t,phoneNumber:e}),n.set(o)},removeAccount:function(t){var e=n.get();e.splice(t,1),n.set(e)},removeAccounts:function(){n.remove()}}}();
var progressBar={update:function(r,t){var a=r+ +$(".progress .progress-bar").attr("aria-valuenow");$(".progress .progress-bar").css("width",a+"%").attr("aria-valuenow",a),$(".progress .val").text(a+"%"),$(".description").text(t)},clear:function(){$(".progress .progress-bar").css("width","0%").attr("aria-valuenow",0),$(".progress .val").text("0%"),$(".description").text("Loading")},calculatePercentage:function(r,t){if(r<t||t<=0)throw new Error("Error! Percent should be >= portion and portion > 0");for(var a=Math.round(r/t),e=a*t-r,o=[],s=0;s<t-1;s++)o.push(a);return e>0||e<0?o.push(a-e):o.push(a),o}};
!function(t){DataStorage={ttnTracking:function(e,a){t.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({modelName:"TrackingDocument",calledMethod:"getStatusDocuments",methodProperties:{Documents:e}}),success:a})},getTtnInfo:function(e,a,o,n){t.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({apiKey:apiKeyArr[i].apiKey,modelName:"InternetDocument",calledMethod:"getDocumentList",methodProperties:{DateTimeFrom:a,DateTimeTo:o,GetFullList:"1",UnassembledCargo:"1"}}),success:n})}}}($);
var table;$.fn.dataTable.ext.search.push(function(e,a){var t=!1,n=!0;return $("#inlineCheckbox1").is(":checked")&&(t=t||a[1].includes("Відмова від отримання"),n=!1),$("#inlineCheckbox2").is(":checked")&&(t=t||a[1].includes("Прибув у відділення"),n=!1),$("#inlineCheckbox3").is(":checked")&&(t=t||!a[6],n=!1),t||n}),$(document).ready(function(){$("#menu-item-2").addClass("menu-active"),table=$("#myTable").DataTable(BuildingData.tables.options.paymentPage);var e={format:"dd.mm.yyyy",autoclose:!0,defaultDateDelta:null};$("#datepickerFrom").datepicker(e),$("#datepickerTo").datepicker(e),$("#datepickerPair").datepair();var a=ClientStorage.getTimeRange();$("#datepickerFrom").val(a.from),$("#datepickerTo").val(a.to),$("#inlineCheckbox1, #inlineCheckbox2, #inlineCheckbox3").on("change",function(){table.draw()})});function getApisData(e,a,t){for(var n=[],r=ClientStorage.getAccounts(),o=progressBar.calculatePercentage(50,r.length),c=0,i=0;i<r.length;i++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({apiKey:r[i].apiKey,modelName:"InternetDocument",calledMethod:"getDocumentList",methodProperties:{DateTimeFrom:e,DateTimeTo:a,GetFullList:"1",UnassembledCargo:"1"}}),success:function(e,a){if(progressBar.update(o[c],"Profiles data loading ("+ ++c+"/"+r.length+")"),n.push(e.data),flags.splice(0,1),!flags.length){for(var t=[],i=0;i<n.length;i++)t=t.concat(n[i]);sendTtnAjax(prepareTtn(t))}}})}var flags=[];function sendTtnAjax(e){for(var a=[],t=progressBar.calculatePercentage(50,e.length),n=0,r=0;r<e.length;r++)flags.push(!0),$.ajax({url:"https://api.novaposhta.ua/v2.0/json/",dataType:"json",type:"post",data:JSON.stringify({modelName:"TrackingDocument",calledMethod:"getStatusDocuments",methodProperties:{Documents:e[r]}}),success:function(r,o){if(progressBar.update(t[n],"TTN data loading ("+ ++n+"/"+e.length+")"),a.push(r.data),flags.splice(0,1),!flags.length){var c=concatTtnArrays(a);console.log("Filtered array "+c.length),drawTable(c)}}})}function concatTtnArrays(e){for(var a=[],t=0;t<e.length;t++)a=a.concat(e[t]);var n={};return a.filter(function(e){return e.Number in n?0:n[e.Number]=1})}function prepareTtn(e){var a,t=0,n=100,r=[];for(r.push([]),a=0;a<e.length;a++)a>=n&&(t++,n+=100,r.push([])),r[t].push({DocumentNumber:e[a].IntDocNumber,Phone:e[a].RecipientContactPhone});return r}function drawTable(e){table.clear(),table.rows.add(e).draw()}$("#checkBtn").click(function(){progressBar.clear();var e=$("#datepickerFrom").val(),a=$("#datepickerTo").val();ClientStorage.updateTimeRange(e,a),getApisData(e,a)}),$("#clearBtn").click(function(){$("#datepickerFrom").val(""),$("#datepickerTo").val(""),ClientStorage.removeTimeRange()});